# ✅ 장비별 PGM 저장 구조 개선: NAS + Internal Disk 통합 대응 전략

---

## 🎯 목적
- NAS가 아닌 **Internal Disk 저장 장비**도 PEN 서버에 동일하게 PGM을 업로드하도록 구성
- **사용자 불편 없이**, PEN 서버가 **중복 제거 + 저장 처리**
- 기존 NAS 방식과 공존 가능

---

## 🧱 전체 구성 구조

``` mermaid
flowchart TD
  %% 장비 그룹 A - NAS 기반
  A1[장비 A1 - NAS]

  %% 장비 그룹 B - Internal Disk 기반
  B1[장비 B1 - Disk]

  %% PEN 서버 내부 처리 (수직 정렬)
  subgraph PEN["PEN 서버"]
    PEN2[PEN 서버 - 목록 비교 후 DB 확인]
    PEN3[PEN 서버 - 중복되지 않은 파일 목록 응답]
    PEN4[PEN 서버 - 파일 저장 및 DB 갱신]
  end

  PEN2 --> PEN3 --> PEN4

  %% NAS 접근 처리 (분리)
  PEN1[PEN 서버 - NAS 파일 접근 및 저장 처리]

  %% 그룹 A 흐름
  A1 -->|업로드 요청 - NAS 경로 전달| PEN1

  %% 그룹 B 흐름
  B1 -->|파일 목록 전송| PEN2

  PEN3 -->|필요 파일 목록 응답| B1

  B1 -->|tar.gz 전송| PEN4

```

---

## 🖥️ 장비(Internal Disk)에서 준비할 구성 요소

| 구성 요소             | 설명                                                  |
|-----------------------|-------------------------------------------------------|
| 🔍 파일 목록 수집기     | 지정 폴더 내 모든 파일의 `mtime + size + filename` 목록 생성 |
| 📤 목록 전송기         | PEN 서버에 HTTP POST로 JSON 목록 전송 (`/api/check`)     |
| 📥 응답 파서           | 서버로부터 “필요한 파일 목록” 수신 (`filenames` 배열)    |
| 📦 파일 압축기         | 응답 받은 파일들만 `tar.gz`로 압축                    |
| 🌐 압축파일 전송기     | 압축 파일을 PEN 서버에 HTTP POST (`/api/upload`) 전송     |
| 💾 상태 저장기 (옵션) | `prev_uploaded.json`로 이전 업로드 이력 저장 가능          |

---

## 📡 PEN 서버에서 준비할 구성 요소

| 구성 요소             | 설명                                                  |
|-----------------------|-------------------------------------------------------|
| ✅ `/api/check`        | 목록(JSON)을 받아 DB와 비교하여 “필요한 파일 목록” 응답       |
| ✅ `/api/upload`       | 클라이언트에서 받은 `tar.gz`를 해제 및 저장             |
| ✅ DB 테이블           | `filename + size + mtime` 또는 `hash`로 중복 감지        |
| ✅ 저장 경로 관리       | 사용자/장비/날짜별 저장 위치 관리                       |

---

## 🧪 성능 구성 전략

1. **파일 목록 생성**
   - 70,000개 기준 ≈ 1~2초 (stat 기반)
   - JSON으로 압축하면 1~2MB 내외

2. **서버 비교**
   - DB에 인덱싱된 `filename + size + mtime` 비교로 1초 이내

3. **파일 전송**
   - 변경 파일만 `tar.gz` (수 MB ~ 수십 MB)
   - HTTP POST 전송 (압축 전송량 줄임)

4. **동시 사용자 고려**
   - 서버는 멀티 장비 요청에 대비해 큐 또는 워커 구조 고려

---

## 🔐 보안 및 인증

- 장비 고유 ID 또는 인증 토큰 포함하여 전송
- HTTPS 적용
- 파일 저장 경로에 사용자 분리 (권한 분리)

---

## ✅ 요약: 장비에서 준비할 것

- `파일 목록 생성기`: 전체 파일 `mtime + size + filename` JSON 생성
- `서버 목록 비교`: HTTP POST 요청으로 목록 전송 → 서버가 필요한 파일 응답
- `압축기`: 응답 받은 파일들만 `.tar.gz`로 묶기
- `전송기`: 서버에 압축 파일 업로드
- `선택적 로깅`: 이전 목록 저장으로 변경 비교 가속 가능

---

## 📌 장점

- NAS와 Internal Disk 장비 간 기능 일관성 확보
- 서버 중심 중복 제거 → 저장 용량 절약
- 사용자는 기존처럼 사용 가능, 백그라운드 자동화 가능

---
